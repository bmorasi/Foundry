import BaseScene from"../../../common/documents/scene.mjs";import ServerDocumentMixin from"../backend/server-document.mjs";import{GRID_TYPES}from"../../../common/constants.mjs";import{setProperty}from"../../../common/utils/helpers.mjs";export default class Scene extends(ServerDocumentMixin(BaseScene)){static isCached=!0;async _preCreate(e,t,o){return this.active&&await this.activate(),super._preCreate(e,t,o)}async _preUpdate(e,t,o){await super._preUpdate(e,t,o),e.active&&await this.activate()}_onDelete(e,t){db.Combat._onDeleteScene(this),db.FogExploration.sublevel.findDelete({scene:this.id})}async activate(){logger.info(`Activating scene ${this.name} [${this.id}]`);const e=await this.constructor.sublevel.findUpdate({active:!0},{active:!1});this.updateSource({active:!0}),game.documentCache.set(this),e.forEach((({_id:e})=>{const t=game.documentCache.get(this.constructor.documentName,e);t&&(t.updateSource({active:!1}),game.documentCache.set(t))}))}static async migrateSystem(){const{logger:e}=global;e.info(`${vtt} | Migrating Scene documents to the latest game system data model`);const t=await this.find({},{}),o=this.db.batch();for(const s of t){for(const t of s.tokens){try{await t.loadRelatedDocuments()}catch(t){e.error(t);continue}const s=t.delta?._source.items||[];if(t.actorLink||!s.length)continue;const c=[];for(const t of s)try{if(t._tombstone)return t;const e=db.Item.fromSource(t);e.updateSource({system:e.migrateSystemData()}),c.push(e.toObject())}catch(t){e.error(t)}t.delta._source.items=c,t.batchWrite(o)}s.batchWrite(o,{writeEmbedded:!1})}await o.write(),globalThis.logger.info(`Successfully migrated ${t.length} Scene documents to the latest system data model.`)}static async get(e,t,o){const s=game.documentCache.get(this.documentName,e)??await super.get(e,t,o);return game.documentCache.set(s),s}static async getMany(e,t){const o=[],s=[];for(const t of e){const e=game.documentCache.get(this.documentName,t);e?s.push(e):o.push(t)}return o.length?s.concat(await super.getMany(e,t)):s}static fromSource(e,t){const o=e.grid?.type??e.gridType;return[GRID_TYPES.HEXODDR,GRID_TYPES.HEXEVENR,GRID_TYPES.HEXODDQ,GRID_TYPES.HEXEVENQ].includes(o)&&!e._stats?.coreVersion&&setProperty(e,"flags.core.legacyHex",!0),super.fromSource(e,t)}static socketListeners(e){e.on("preloadScene",this.#e.bind(e)),e.on("pullToScene",this.#t.bind(e))}static#e(e,t){this.broadcast.emit("preloadScene",e),t(e)}static async#t(e,t){if(!this.user.isGM)return;const o=(await db.User.get(t,{strict:!0})).sockets;o.length&&o.forEach((t=>this.server.to(t.id).emit("pullToScene",e)))}}